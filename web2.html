<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KI Webinar-Assistent (Shiripour Edition)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- External libraries for export functionality -->
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" crossorigin="anonymous"></script>

  <style>
    :root {
      --brand-primary: #6a0dad;
      --brand-secondary: #ffd700;
      --brand-dark: #120c18;
      --text-light: #f7fafc;
      --text-dark: #1a202c;
      --success: #28a745;
      --error: #dc2626;
      --info: #2563eb;
    }
    body { background-color: #f0f2f5; font-family: 'Open Sans', sans-serif; color: var(--text-dark); }
    h1, h2, h3, .font-title { font-family: 'Montserrat', sans-serif; }
    .shiripour-gradient-bg { background: linear-gradient(135deg, var(--brand-primary) 0%, #8a2be2 100%); }
    .shiripour-gradient-text { background: linear-gradient(135deg, var(--brand-primary) 0%, #c4b5fd 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .cta-button { background: linear-gradient(to right, var(--brand-secondary), #ffeb3b); color: #333; font-family: 'Montserrat', sans-serif; font-weight: 700; border-radius: 8px; text-transform: uppercase; transition: all 0.3s ease; box-shadow: 0 4px 14px 0 rgba(0,0,0,0.1); border-bottom: 3px solid #e0b400; }
    .cta-button:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 6px 20px 0 rgba(0,0,0,0.2); }
    .input-field:focus { border-color: var(--brand-primary); box-shadow: 0 0 0 3px rgba(106, 13, 173, 0.2); outline: none; }
    .input-file { width: 100%; font-size: 0.875rem; color: #4a5568; margin-top: 0.25rem; }
    .input-file::file-selector-button { margin-right: 1rem; padding: 0.5rem 1rem; border-radius: 9999px; border: 0; font-size: 0.875rem; font-weight: 600; background-color: #f3e8ff; color: #6b21a8; }
    .input-file::file-selector-button:hover { background-color: #e9d5ff; }

    .slide-container { aspect-ratio: 16 / 9; width: 100%; max-width: 1100px; box-shadow: 0 15px 45px rgba(0,0,0,0.2); border-radius: 12px; overflow: hidden; position: relative; transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out; background-color: #fff; }
    .slide-hidden { opacity: 0; transform: scale(0.95); }
    .slide-container.theme-light { --bg-slide: #ffffff; --text-primary: #000000; --text-secondary: #4a5568; --border-color: #e2e8f0; }
    .slide-container.theme-dark { --bg-slide: var(--brand-dark); --text-primary: #ffffff; --text-secondary: #a0aec0; --border-color: #4a5568; }
    .slide-content-wrapper { width: 100%; height: 100%; background-color: var(--bg-slide); color: var(--text-primary); position: relative; }
    [contenteditable]:hover { outline: 2px dashed var(--brand-primary); cursor: text; }
    [contenteditable]:focus { outline: 2px solid var(--brand-primary); background-color: rgba(106, 13, 173, 0.1); box-shadow: 0 0 10px rgba(106, 13, 173, 0.3); }
    .draggable { cursor: move; user-select: none; }
    .slide-footer, .slide-logo { position: absolute; font-size: 0.75rem; color: var(--text-secondary); z-index: 10; }
    .slide-footer { bottom: 2%; right: 3%; }
    .slide-logo { top: 2%; left: 3%; max-width: 150px; position: absolute; }
    .slide-logo img { width: 100%; height: auto; }

    .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--brand-primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .step-progress { display: flex; justify-content: space-between; position: relative; width: 100%; max-width: 600px; margin: 2rem auto; }
    .step-progress::before { content: ''; position: absolute; top: 15px; left: 10%; right: 10%; height: 2px; background-color: #ccc; z-index: 0; }
    #step-progress-bar { position: absolute; top: 15px; left: 10%; width: 0%; height: 2px; background: var(--brand-primary); z-index: 0; transition: width 0.5s ease; }
    .step { text-align: center; z-index: 1; }
    .step-circle { width: 30px; height: 30px; border-radius: 50%; background-color: #ccc; color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; transition: background-color 0.3s; margin: 0 auto; }
    .step.active .step-circle { background-color: var(--brand-primary); }
    .step.completed .step-circle { background-color: var(--success); }
    .step-label { margin-top: 0.5rem; font-size: 0.8rem; color: #666; transition: color 0.3s; }
    .step.active .step-label, .step.completed .step-label { color: #000; font-weight: bold; }

    #generation-status { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 50; transition: opacity 0.3s ease; backdrop-filter: blur(5px); }
    .theme-light #generation-status { background-color: rgba(255, 255, 255, 0.8); }
    .theme-dark  #generation-status { background-color: rgba(18, 12, 24, 0.8); }
    #generation-status.hidden { opacity: 0; pointer-events: none; }

    .toast { position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 8px; color: white; z-index: 10000; opacity: 0; transform: translateY(-20px); transition: opacity 0.3s ease, transform 0.3s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background-color: var(--success); }
    .toast.error { background-color: var(--error); }
    .toast.info { background-color: var(--info); }

    #text-command-center { position: absolute; display: none; background-color: #333; color: white; padding: 5px; border-radius: 6px; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); gap: 5px; }
    #text-command-center.show { display: flex; }
    #text-command-center button, #text-command-center select, #text-command-center input { background-color: #555; color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 14px; }
    #text-command-center button:hover { background-color: var(--brand-primary); }
  </style>
</head>
<body class="flex flex-col md:flex-row min-h-screen">
  <aside class="sidebar w-full md:w-96 p-6 bg-white shadow-lg md:h-screen md:sticky top-0 overflow-y-auto transition-all duration-300">
    <h2 class="text-3xl font-black mb-6 shiripour-gradient-text">Steuerzentrale</h2>

    <!-- Step 2 Controls: Design & Customization -->
    <div id="step2-controls" class="hidden space-y-6">
      <button id="back-to-step1-btn" class="w-full bg-gray-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-600 transition-colors">&larr; Zurück zu Schritt 1</button>
      <div>
        <label for="slide-count-slider" class="block text-sm font-medium">Folienanzahl (ca.): <span id="slide-count-display" class="font-bold">200</span></label>
        <input type="range" id="slide-count-slider" min="10" max="300" value="200" step="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2">
      </div>
      <div>
        <label class="block text-sm font-medium">Hintergrund</label>
        <div class="mt-1 flex rounded-md shadow-sm">
          <button id="theme-light-btn" class="theme-btn flex-1 rounded-l-md px-4 py-2 text-sm border border-gray-300" data-theme="light">Hell</button>
          <button id="theme-dark-btn" class="theme-btn flex-1 rounded-r-md px-4 py-2 text-sm border border-gray-300" data-theme="dark">Dunkel</button>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium">Logo Upload</label>
        <input type="file" id="logo-upload" accept="image/*" class="input-file">
      </div>
      <button id="generate-and-preview-btn" class="w-full cta-button py-3 px-4">Webinar generieren (Schritt 3) &rarr;</button>
    </div>

    <!-- Step 3 Controls: Editing & Export -->
    <div id="step3-controls" class="hidden space-y-4">
      <button id="back-to-step2-btn" class="w-full bg-gray-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-600 transition-colors">&larr; Zurück zu Schritt 2</button>
      <h3 class="font-bold text-lg pt-4">Folien-Editor</h3>
      <button id="undo-btn" class="w-full bg-gray-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-600 transition-colors">Rückgängig</button>
      <div>
        <label class="block text-sm font-medium">Logo Position & Größe</label>
        <input type="range" id="logo-x" min="0" max="95" value="3" class="w-full mt-1" title="X-Position (%)">
        <input type="range" id="logo-y" min="0" max="95" value="2" class="w-full" title="Y-Position (%)">
        <input type="range" id="logo-size" min="5" max="30" value="15" class="w-full" title="Größe (%)">
      </div>
      <p class="text-xs text-gray-500 italic">Klicke auf Textelemente in der Vorschau, um sie zu bearbeiten und zu verschieben.</p>
    </div>
  </aside>

  <main class="flex-1 flex flex-col items-center justify-start p-4 md:p-8">
    <!-- Step Progress Bar -->
    <div class="step-progress">
      <div id="step-progress-bar"></div>
      <div id="step1" class="step"><div class="step-circle">1</div><div class="step-label">Inhalt & KI</div></div>
      <div id="step2" class="step"><div class="step-circle">2</div><div class="step-label">Design</div></div>
      <div id="step3" class="step"><div class="step-circle">3</div><div class="step-label">Vorschau & Export</div></div>
    </div>

    <div id="main-content-area" class="w-full mt-4">
      <!-- Step 1 Content: Inputs -->
      <div id="step1-content" class="w-full max-w-4xl p-6 bg-white rounded-lg shadow-xl mx-auto">
        <h3 class="font-title font-black text-2xl mb-6 text-center">Schritt 1: Gib der KI Futter</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-4">
            <div>
              <label for="api-key-input" class="block text-sm font-medium">Dein Google AI API Key</label>
              <input type="password" id="api-key-input" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm input-field" placeholder="Erforderlich für die KI-Generierung" required>
            </div>
            <div>
              <label for="moderator-name-input" class="block text-sm font-medium">Dein Name / Moderator</label>
              <input type="text" id="moderator-name-input" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm input-field" placeholder="z.B. Said Shiripour" required>
            </div>
            <div>
                <label for="webinar-name-input" class="block text-sm font-medium">Name des Webinars</label>
                <input type="text" id="webinar-name-input" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm input-field" placeholder="z.B. Kettenbrecher Premium Training" required>
            </div>
            <div>
                <label for="webinar-benefit-input" class="block text-sm font-medium">Hauptbenefit des Webinars (in Zahlen)</label>
                <input type="text" id="webinar-benefit-input" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm input-field" placeholder="z.B. Wie du deine ersten 1000€ verdienst" required>
            </div>
            <div>
              <label for="hero-story-upload" class="block text-sm font-medium">1. Deine Heldenstory (TXT)</label>
              <input type="file" id="hero-story-upload" accept=".txt" class="input-file" required>
            </div>
            <div>
              <label for="product-upload" class="block text-sm font-medium">2. Deine Produktinfos & USP (TXT)</label>
              <input type="file" id="product-upload" accept=".txt" class="input-file" required>
            </div>
            
          </div>
          <div class="space-y-4">
            <div>
              <label for="audience-upload" class="block text-sm font-medium">3. Deine Zielgruppe (Probleme & Wünsche) (TXT)</label>
              <input type="file" id="audience-upload" accept=".txt" class="input-file" required>
            </div>
            <div>
              <label for="faq-upload" class="block text-sm font-medium">4. Einwände & FAQs (MD/TXT)</label>
              <input type="file" id="faq-upload" accept=".md,.txt" class="input-file">
            </div>
            <div>
                <label class="block text-sm font-medium">Anredeform</label>
                <div class="mt-1 flex rounded-md shadow-sm">
                    <button id="address-form-du" class="address-form-btn flex-1 rounded-l-md px-4 py-2 text-sm border border-gray-300" data-form="du">Du (informell)</button>
                    <button id="address-form-sie" class="address-form-btn flex-1 rounded-r-md px-4 py-2 text-sm border border-gray-300" data-form="sie">Sie (formell)</button>
                </div>
            </div>
            <div>
                <label for="cta-input" class="block text-sm font-medium">Call-To-Action (Webinar-Ziel)</label>
                <input type="text" id="cta-input" class="w-full p-2 border border-gray-300 rounded-md shadow-sm input-field" placeholder="z.B. Kauf meines Kurses 'XYZ'">
            </div>
             <div>
                <label for="gift-promise-input" class="block text-sm font-medium">Geschenkversprechen (für alle, die bleiben)</label>
                <input type="text" id="gift-promise-input" class="w-full p-2 border border-gray-300 rounded-md shadow-sm input-field" placeholder="z.B. eine exklusive PDF-Checkliste">
            </div>
            <div>
              <label for="product-modules" class="block text-sm font-medium">Produkt-Module (kommagetrennt)</label>
              <input type="text" id="product-modules" class="w-full p-2 border border-gray-300 rounded-md shadow-sm input-field" placeholder="Modul 1, Modul 2, ...">
            </div>
            <div>
              <label for="bonus-info" class="block text-sm font-medium">Bonus-Angebote (kommagetrennt)</label>
              <input type="text" id="bonus-info" class="w-full p-2 border border-gray-300 rounded-md shadow-sm input-field" placeholder="Bonus 1, Bonus 2, ...">
            </div>
            <div>
              <label for="pricing-info" class="block text-sm font-medium">Preisstaffelung (kommagetrennt)</label>
              <input type="text" id="pricing-info" class="w-full p-2 border border-gray-300 rounded-md shadow-sm input-field" placeholder="Gesamtwert, Rabattpreis 1, Endpreis">
            </div>
            <div>
              <label for="guarantee-days" class="block text-sm font-medium">Garantie</label>
              <select id="guarantee-days" class="w-full p-2 border border-gray-300 rounded-md shadow-sm input-field">
                <option value="0">Keine Garantie</option>
                <option value="14">14 Tage</option>
                <option value="30">30 Tage</option>
                <option value="60">60 Tage</option>
              </select>
            </div>
          </div>
        </div>
        <button id="go-to-step2-btn" class="w-full mt-8 cta-button py-3 px-4">Weiter zu Schritt 2 &rarr;</button>
      </div>

      <!-- Step 3 Content: Preview & Export -->
      <div id="preview-area" class="w-full flex flex-col items-center justify-center hidden relative">
        <div id="slide-container" class="slide-container"></div>
        <div class="flex items-center justify-center mt-6 space-x-2 sm:space-x-4">
          <button id="prev-slide" class="shiripour-gradient-bg text-white py-2 px-6 rounded-lg font-bold transition-transform hover:scale-105 disabled:opacity-50">&larr;</button>
          <div class="text-lg font-semibold">
            <input type="number" id="slide-number-input" min="1" class="w-16 text-center p-1 border border-gray-300 rounded-md input-field" value="1"> / <span id="total-slides">0</span>
          </div>
          <button id="next-slide" class="shiripour-gradient-bg text-white py-2 px-6 rounded-lg font-bold transition-transform hover:scale-105">&rarr;</button>
          <button id="fullscreen-btn" class="shiripour-gradient-bg text-white py-2 px-6 rounded-lg font-bold transition-transform hover:scale-105">Vollbild</button>
          <button id="download-script-btn" class="shiripour-gradient-bg text-white py-2 px-6 rounded-lg font-bold transition-transform hover:scale-105 hidden">Skript (.doc)</button>
          <button id="download-pptx-btn" class="cta-button py-2 px-4">Export (.pptx)</button>
        </div>
        <!-- Loading overlay during generation -->
        <div id="generation-status" class="hidden">
          <div class="loader mx-auto"></div>
          <p id="progress-text" class="text-sm text-gray-600 mt-2">Generiere Webinar...</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Floating Text Editor Toolbar -->
  <div id="text-command-center">
    <select id="font-family-select"><option value="Montserrat">Montserrat</option><option value="Open Sans">Open Sans</option></select>
    <input type="number" id="font-size-input" min="10" max="120" value="48" class="w-16">
    <input type="color" id="font-color-input" value="#000000">
    <button id="font-bold-btn"><b>B</b></button>
    <button id="font-italic-btn"><i>I</i></button>
  </div>

  <!-- Fullscreen Modal Overlay -->
  <div id="fullscreen-overlay" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden items-center justify-center p-4 cursor-pointer"></div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // --- STATE MANAGEMENT ---
    let appState = {
      currentStep: 1, webinarScript: [],
      speakerNotes: [], currentSlideIndex: 0, apiKey: '', moderatorName: '', slideCount: 200, theme: 'light', logoUrl: '',
      heroStoryContent: '', productContent: '', audienceContent: '', faqContent: '', productModules: [], bonusInfo: [], pricingInfo: [], guarantee: '',
      giftPromise: '', callToAction: '', addressForm: 'du', webinarName: '', webinarBenefit: '',
      elementPositions: {}, history: []
    };

    // --- DOM ELEMENT CACHING ---
    const dom = {
      sidebar: { step2Controls: document.getElementById('step2-controls'), step3Controls: document.getElementById('step3-controls'), slideCountSlider: document.getElementById('slide-count-slider'), slideCountDisplay: document.getElementById('slide-count-display'), themeLightBtn: document.getElementById('theme-light-btn'), themeDarkBtn: document.getElementById('theme-dark-btn'), logoUpload: document.getElementById('logo-upload'), logoX: document.getElementById('logo-x'), logoY: document.getElementById('logo-y'), logoSize: document.getElementById('logo-size'), undoBtn: document.getElementById('undo-btn') },
      main: { step1Content: document.getElementById('step1-content'), previewArea: document.getElementById('preview-area'), slideContainer: document.getElementById('slide-container'), prevBtn: document.getElementById('prev-slide'), nextBtn: document.getElementById('next-slide'), slideNumberInput: document.getElementById('slide-number-input'), totalSlides: document.getElementById('total-slides'), generationStatus: document.getElementById('generation-status'), progressText: document.getElementById('progress-text'), fullscreenOverlay: document.getElementById('fullscreen-overlay') },
      steps: { step1: document.getElementById('step1'), step2: document.getElementById('step2'), step3: document.getElementById('step3'), progressBar: document.getElementById('step-progress-bar') },
      inputs: { apiKeyInput: document.getElementById('api-key-input'), moderatorName: document.getElementById('moderator-name-input'), heroStory: document.getElementById('hero-story-upload'), product: document.getElementById('product-upload'), audience: document.getElementById('audience-upload'), faq: document.getElementById('faq-upload'), productModules: document.getElementById('product-modules'), bonusInfo: document.getElementById('bonus-info'), pricingInfo: document.getElementById('pricing-info'), guaranteeDays: document.getElementById('guarantee-days'), giftPromise: document.getElementById('gift-promise-input'), callToAction: document.getElementById('cta-input'), addressFormDu: document.getElementById('address-form-du'), addressFormSie: document.getElementById('address-form-sie'), webinarName: document.getElementById('webinar-name-input'), webinarBenefit: document.getElementById('webinar-benefit-input') },
      buttons: { goToStep2: document.getElementById('go-to-step2-btn'), backToStep1: document.getElementById('back-to-step1-btn'), backToStep2: document.getElementById('back-to-step2-btn'), generateAndPreview: document.getElementById('generate-and-preview-btn'), downloadScript: document.getElementById('download-script-btn'), downloadPptx: document.getElementById('download-pptx-btn'), fullscreenBtn: document.getElementById('fullscreen-btn') },
      textEditor: { commandCenter: document.getElementById('text-command-center'), fontFamily: document.getElementById('font-family-select'), fontSize: document.getElementById('font-size-input'), fontColor: document.getElementById('font-color-input'), boldBtn: document.getElementById('font-bold-btn'), italicBtn: document.getElementById('font-italic-btn') }
    };

    let activeTextElement = null;

    // --- UNDO/HISTORY FUNCTIONS ---
    const saveState = () => { appState.history.push(JSON.parse(JSON.stringify({ elementPositions: appState.elementPositions, webinarScript: appState.webinarScript }))); };
    const undoLastAction = () => {
      if (appState.history.length > 1) {
        appState.history.pop();
        const prev = appState.history[appState.history.length - 1];
        appState.elementPositions = JSON.parse(JSON.stringify(prev.elementPositions));
        appState.webinarScript = JSON.parse(JSON.stringify(prev.webinarScript));
        renderSlide(appState.currentSlideIndex);
        showToast('Letzte Aktion rückgängig gemacht', 'info');
      } else {
        showToast('Keine weiteren Aktionen zum Rückgängigmachen', 'info');
      }
    };

    // --- HELPER FUNCTIONS ---
    const escapeForPrompt = (str) => {
      if (!str) return '';
      return str.replace(/"/g, "'").replace(/\n/g, ' ').replace(/\r/g, '');
    };

    const readFileAsText = (file) => new Promise((resolve, reject) => {
      if (!file) return resolve('');
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = e => reject(e);
      reader.readAsText(file);
    });
    const getImageUrl = (file) => new Promise((resolve) => {
      if (!file) return resolve('');
      const reader = new FileReader();
      reader.onload = (e) => resolve(e.target.result);
      reader.readAsDataURL(file);
    });
    const showToast = (message, type = 'success', duration = 3000) => {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, duration);
    };
    const yieldToUI = () => new Promise(r => setTimeout(r, 0));
    const rgbToHex = (rgb) => {
        if (!rgb || !rgb.startsWith('rgb')) return rgb;
        let sep = rgb.indexOf(',') > -1 ? ',' : ' ';
        rgb = rgb.substr(4).split(')')[0].split(sep);
        let r = (+rgb[0]).toString(16).padStart(2, '0');
        let g = (+rgb[1]).toString(16).padStart(2, '0');
        let b = (+rgb[2]).toString(16).padStart(2, '0');
        return `#${r}${g}${b}`;
    };

    // --- UI FUNCTIONS ---
    const toggleModalFullscreen = () => {
      const overlay = dom.main.fullscreenOverlay;
      const isVisible = !overlay.classList.contains('hidden');
      if (isVisible) {
        overlay.classList.add('hidden');
        overlay.innerHTML = '';
        dom.buttons.fullscreenBtn.textContent = 'Vollbild';
      } else {
        const slideClone = dom.main.slideContainer.cloneNode(true);
        slideClone.style.maxWidth = '95vw';
        slideClone.style.maxHeight = 'calc(95vh - 20px)';
        slideClone.style.width = 'auto';
        slideClone.style.height = 'auto';
        slideClone.style.cursor = 'default';
        overlay.appendChild(slideClone);
        overlay.classList.remove('hidden');
        dom.buttons.fullscreenBtn.textContent = 'Beenden';
      }
    };

    const updateStepUI = () => {
      const { currentStep } = appState;
      dom.main.step1Content.classList.add('hidden');
      dom.sidebar.step2Controls.classList.add('hidden');
      dom.main.previewArea.classList.add('hidden');
      dom.sidebar.step3Controls.classList.add('hidden');

      if (currentStep === 1) dom.main.step1Content.classList.remove('hidden');
      if (currentStep === 2) dom.sidebar.step2Controls.classList.remove('hidden');
      if (currentStep === 3) { dom.main.previewArea.classList.remove('hidden'); dom.sidebar.step3Controls.classList.remove('hidden'); }

      [1,2,3].forEach(i => dom.steps[`step${i}`].classList.remove('active', 'completed'));
      for (let i = 1; i <= currentStep; i++) dom.steps[`step${i}`].classList.add(i < currentStep ? 'completed' : 'active');
      dom.steps.progressBar.style.width = `${((currentStep - 1) / 2) * 80}%`;
    };

    const applyTheme = (theme) => {
      appState.theme = theme;
      dom.main.slideContainer.className = `slide-container theme-${theme}`;
      dom.sidebar.themeLightBtn.classList.toggle('shiripour-gradient-bg', theme === 'light');
      dom.sidebar.themeLightBtn.classList.toggle('text-white', theme === 'light');
      dom.sidebar.themeDarkBtn.classList.toggle('shiripour-gradient-bg', theme === 'dark');
      dom.sidebar.themeDarkBtn.classList.toggle('text-white', theme === 'dark');
      if (appState.webinarScript.length > 0) renderSlide(appState.currentSlideIndex);
    };
    
    const applyAddressForm = (form) => {
        appState.addressForm = form;
        dom.inputs.addressFormDu.classList.toggle('shiripour-gradient-bg', form === 'du');
        dom.inputs.addressFormDu.classList.toggle('text-white', form === 'du');
        dom.inputs.addressFormSie.classList.toggle('shiripour-gradient-bg', form === 'sie');
        dom.inputs.addressFormSie.classList.toggle('text-white', form === 'sie');
    };

    // --- API & GENERATION ---
    const callGeminiApi = async (prompt) => {
      if (!appState.apiKey) { showToast('API Key fehlt. Bitte in Schritt 1 eingeben.', 'error'); throw new Error('API Key is missing.'); }
      const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${appState.apiKey}`;
      const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: 'application/json' } };
      const maxRetries = 5; let lastError = null;
      for (let i = 0; i < maxRetries; i++) {
        try {
          const resp = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          if (resp.ok) return resp.json();
          if (resp.status === 503 || resp.status === 429) { 
              const delay = Math.pow(2, i) * 2000; 
              dom.main.progressText.textContent = `API überlastet (Fehler ${resp.status}). Nächster Versuch in ${delay/1000}s...`; 
              await new Promise(res=>setTimeout(res, delay)); 
              continue; 
          }
          lastError = new Error(`HTTP ${resp.status}`); break;
        } catch (e) { lastError = e; const delay = Math.pow(2, i) * 2000; dom.main.progressText.textContent = `Netzwerkfehler. Nächster Versuch in ${delay/1000}s...`; await new Promise(res=>setTimeout(res, delay)); }
      }
      throw lastError || new Error('API-Anfrage fehlgeschlagen.');
    };

    // --- MODULAR WEBINAR GENERATION based on 12-Step-Plan ---
    const generateWebinar = async () => {
      appState.currentStep = 3; updateStepUI();
      dom.main.generationStatus.classList.remove('hidden');
      dom.main.slideContainer.classList.add('slide-hidden');
      document.querySelectorAll('#preview-area > .flex').forEach(el => el.classList.add('hidden'));
      dom.buttons.generateAndPreview.disabled = true;

      let allSlides = [];
      let allSpeakerNotes = [];
      const totalSlideCount = appState.slideCount;

      const webinarStructure = [
          { name: "Schritt 1-3: Intro, Bonus & Fokus", percentage: 0.10, instructions: `Erstelle die Startfolie mit dem Webinarnamen '${escapeForPrompt(appState.webinarName)}' und dem Hauptnutzen '${escapeForPrompt(appState.webinarBenefit)}'. Stelle den Moderator '${escapeForPrompt(appState.moderatorName)}' vor. Kündige das Geschenk '${escapeForPrompt(appState.giftPromise)}' für Teilnehmer an, die bis zum Ende bleiben. Fordere die Teilnehmer auf, sich zu konzentrieren und Ablenkungen zu entfernen, da es keine Aufzeichnung geben wird.` },
          { name: "Schritt 4-5: Heldenstory & Motivation", percentage: 0.20, instructions: `Erzähle die Heldenstory des Moderators, um ihn als Experten zu positionieren. Die Story soll die Situation der Zielgruppe widerspiegeln und zeigen, dass Erfolg möglich ist. Motiviere die Teilnehmer, indem du ihnen das Gefühl gibst, dass sie ihre Ziele auch erreichen können. Fordere zu einer Interaktion im Chat auf (z.B. "Schreibe 'ICH WILL' in den Chat!").` },
          { name: "Schritt 6-8: Content, Problem & Wunschzustand", percentage: 0.30, instructions: `Gib einen Einblick in das Thema (basierend auf den Produktinfos), ohne zu überfordern. Vertiefe das Kernproblem der Zielgruppe, um Dringlichkeit zu erzeugen. Male dann ein emotionales Bild des Wunschzustands (Ziele, Träume, Sorgenfreiheit), um ein positives Kopfkino zu erzeugen und die Brücke zur Lösung zu schlagen.` },
          { name: "Schritt 9-10: Produktvorstellung & Inhalte", percentage: 0.15, instructions: `Präsentiere das Produkt als die perfekte und einzigartige Lösung. Hebe das Alleinstellungsmerkmal hervor. Stelle die einzelnen Module vor: ${appState.productModules.join(', ')}. Erkläre den Nutzen jedes Moduls und fasse den Gesamtwert zusammen.` },
          { name: "Schritt 11: Verkaufsphase & CTA", percentage: 0.20, instructions: `Starte die Haupt-Verkaufsphase. Präsentiere die Bonus-Angebote: ${appState.bonusInfo.join(', ')}. Baue den Wert auf und präsentiere dann die Preisstaffelung: [${appState.pricingInfo.join(', ')}]. WICHTIG: Erstelle separate Folien, um den Preis schrittweise zu enthüllen (Value Stack -> Preisanker -> Rabatt -> Endpreis). Gib einen starken Call-To-Action zum Ziel: '${escapeForPrompt(appState.callToAction)}'. Erwähne die Garantie: '${escapeForPrompt(appState.guarantee)}'.` },
          { name: "Schritt 12: Abschluss & FAQ", percentage: 0.05, instructions: `Nimm häufige Einwände und Ausreden vorweg (basierend auf den FAQs). Beantworte die wichtigsten Fragen aus den FAQs (eine Folie pro Frage/Antwort-Paar). Wiederhole den Call-To-Action. Bedanke dich bei den Teilnehmern und zeige eine Abschlussfolie.` }
      ];

      try {
        for (const section of webinarStructure) {
          const sectionSlideCount = Math.max(2, Math.round(totalSlideCount * section.percentage));
          dom.main.progressText.textContent = `Generiere Sektion: ${section.name} (ca. ${sectionSlideCount} Folien)...`;

          const prompt = `
            **PERSPEKTIVE & STIL:** Schreibe ALLE Texte (Folien und Sprechernotizen) aus der Ich-Perspektive des Moderators (${escapeForPrompt(appState.moderatorName)}). Nutze eine direkte Ansprache an das Publikum in der **${appState.addressForm === 'du' ? 'informellen "Du"-Form' : 'formellen "Sie"-Form'}**.
            **WICHTIGSTE REGEL:** Deine GESAMTE Antwort MUSS AUSSCHLIESSLICH ein einziges, 100% valides JSON-Objekt sein. Kein einleitender Text, kein Markdown. Nur das JSON.
            **HAUPTTHEMA:** Das zentrale Thema des Webinars ist das Produkt, beschrieben in: "${escapeForPrompt(appState.productContent)}". Das Geschenkversprechen ist NUR ein Bonus.
            **JSON-SCHEMA:** Das Objekt muss die Form { "slides": [...], "speakerNotes": [...] } haben.
            * Jedes Objekt im 'slides'-Array MUSS diesem Schema folgen: { "type": "string", "layout": "string", "content": { "title": "string", "subtitle": "string", "points": ["string"] }, "image_prompt": "string" }.
            * Das 'speakerNotes'-Array muss genauso viele Elemente haben wie das 'slides'-Array.
            * Benutze IMMER doppelte Anführungszeichen (") für alle Schlüssel und Strings. Escapes alle doppelten Anführungszeichen innerhalb von Strings mit einem Backslash (\\").
            * **KEINE ANWEISUNGEN IM INHALT:** Die Folientitel und -texte dürfen NIEMALS die Namen der Sektionen (z.B. 'Intro & Hook', 'Heldenstory') oder Anweisungen (z.B. 'Kapitel 1', 'Call to Action') enthalten. Erzeuge stattdessen kreative, emotionale Überschriften, die zum Thema passen.
            * JEDE Folie MUSS mindestens einen aussagekräftigen 'title' haben. Leere Folien sind nicht erlaubt.

            **AUFTRAG:** Erstelle die Webinar-Sektion "${section.name}".
            **FOKUS:** ${section.instructions}
            **ANZAHL FOLIEN:** ca. ${sectionSlideCount} Folien.
            
            **KONTEXT:**
            * Moderator: "${escapeForPrompt(appState.moderatorName)}"
            * Webinar-Name: "${escapeForPrompt(appState.webinarName)}"
            * Haupt-Benefit: "${escapeForPrompt(appState.webinarBenefit)}"
            * Heldenstory: "${escapeForPrompt(appState.heroStoryContent)}"
            * Produkt: "${escapeForPrompt(appState.productContent)}"
            * Zielgruppe (Probleme & Wünsche): "${escapeForPrompt(appState.audienceContent)}"
            * FAQs & Einwände: "${escapeForPrompt(appState.faqContent)}"
          `;

          const result = await callGeminiApi(prompt);
          let jsonString = result.candidates?.[0]?.content?.parts?.[0]?.text;
          
          if (!jsonString) {
              throw new Error(`Leere Antwort von der KI für Sektion "${section.name}".`);
          }

          let cleanJsonString = jsonString
              .replace(/^```json\s*/, '')
              .replace(/```$/, '')
              .trim();

          const firstBracket = cleanJsonString.indexOf('{');
          const lastBracket = cleanJsonString.lastIndexOf('}');
          if (firstBracket !== -1 && lastBracket > firstBracket) {
              cleanJsonString = cleanJsonString.substring(firstBracket, lastBracket + 1);
          } else {
              console.error("Raw response from AI:", jsonString);
              throw new Error(`Kein valides JSON-Objekt in der KI-Antwort für Sektion "${section.name}" gefunden.`);
          }

          cleanJsonString = cleanJsonString.replace(/,\s*([\]}])/g, '$1');

          let pkg;
          try {
              pkg = JSON.parse(cleanJsonString);
          } catch (err) {
              console.error("Failed to parse JSON:", cleanJsonString);
              throw new Error(`KI gab kein valides JSON für Sektion "${section.name}" zurück. Details im Konsolen-Log.`);
          }
          
          if (!Array.isArray(pkg.slides) || !Array.isArray(pkg.speakerNotes)) { throw new Error(`Ungültiges Datenformat in Sektion "${section.name}".`); }
          
          allSlides.push(...pkg.slides);
          allSpeakerNotes.push(...pkg.speakerNotes);
          await yieldToUI();
          await new Promise(res => setTimeout(res, 1000)); // Add 1-second delay between sections
        }

        appState.webinarScript = allSlides; 
        appState.speakerNotes = allSpeakerNotes; 
        appState.history = []; 
        saveState();
        dom.buttons.downloadScript.classList.remove('hidden');
        renderSlide(0);
        showToast(`Webinar mit ${allSlides.length} Folien erfolgreich generiert!`, 'success');

      } catch (e) {
        console.error('Generation Fehler', e); showToast(`Generierung fehlgeschlagen: ${e.message}`, 'error'); appState.currentStep = 2; updateStepUI();
      } finally {
        dom.main.generationStatus.classList.add('hidden');
        dom.main.slideContainer.classList.remove('slide-hidden');
        document.querySelectorAll('#preview-area > .flex').forEach(el => el.classList.remove('hidden'));
        dom.buttons.generateAndPreview.disabled = false;
      }
    };

    // --- RENDER & DRAG --- 
    const renderSlide = (index, targetContainer = dom.main.slideContainer) => {
      if (!appState.webinarScript.length) return;
      if (targetContainer === dom.main.slideContainer) appState.currentSlideIndex = index;
      
      const slideData = appState.webinarScript[index];
      if (!slideData) { console.error(`Keine Foliendaten für Index ${index}`); return; }

      targetContainer.innerHTML = '';
      targetContainer.className = `slide-container theme-${appState.theme}`;
      const wrapper = document.createElement('div'); 
      wrapper.className = 'slide-content-wrapper p-8 flex flex-col justify-center items-center';
      
      const slidePositions = appState.elementPositions[index] || {};
      const content = slideData.content || {};

      const logoContainer = document.createElement('div');
      logoContainer.className = 'slide-logo draggable';
      logoContainer.dataset.key = 'logo';
      const logoPos = slidePositions.logo?.position;
      logoContainer.style.left = logoPos?.left || `${dom.sidebar.logoX.value}%`;
      logoContainer.style.top = logoPos?.top || `${dom.sidebar.logoY.value}%`;
      logoContainer.style.width = logoPos?.width || `${dom.sidebar.logoSize.value}%`;
      if (appState.logoUrl) logoContainer.innerHTML = `<img src="${appState.logoUrl}" alt="Logo">`;
      else logoContainer.textContent = appState.moderatorName;
      targetContainer.appendChild(logoContainer);

      const footer = document.createElement('div');
      footer.className = 'slide-footer';
      footer.textContent = `${index + 1}`;
      targetContainer.appendChild(footer);

      const layout = slideData.layout || 'default';
      let mainContentArea;

      if (layout.startsWith('split')) {
          mainContentArea = document.createElement('div');
          mainContentArea.className = 'flex w-full h-full gap-8 items-center';
          const textContainer = document.createElement('div');
          textContainer.className = 'w-1/2 flex flex-col justify-center text-left slide-text-container';
          const imageContainer = document.createElement('div');
          imageContainer.className = 'w-1/2 h-4/5 flex items-center justify-center bg-gray-100 dark:bg-gray-800 rounded-lg border-2 border-dashed border-gray-400 p-4 text-center text-sm text-gray-500';
          imageContainer.innerHTML = slideData.image_prompt || 'Bild-Platzhalter';
          
          if (layout === 'split_left_text') {
              mainContentArea.appendChild(textContainer);
              mainContentArea.appendChild(imageContainer);
          } else { // split_right_text
              mainContentArea.appendChild(imageContainer);
              mainContentArea.appendChild(textContainer);
          }
          wrapper.appendChild(mainContentArea);
      } else { // default layout
          mainContentArea = document.createElement('div');
          mainContentArea.className = 'flex flex-col justify-center items-center text-center w-full h-full gap-4';
          wrapper.appendChild(mainContentArea);
      }

      const textTarget = layout.startsWith('split') ? mainContentArea.querySelector('.slide-text-container') : mainContentArea;

      if (content.title) {
        const el = document.createElement('h1');
        el.className = 'draggable font-title text-4xl font-black shiripour-gradient-text';
        el.dataset.key = 'title';
        el.innerHTML = content.title;
        Object.assign(el.style, slidePositions.title?.styles || { fontFamily: 'Montserrat', fontSize: '3rem', fontWeight: '900' });
        if(slidePositions.title?.position) { el.style.position = 'absolute'; Object.assign(el.style, slidePositions.title.position); wrapper.appendChild(el); } else { textTarget.appendChild(el); }
      }
      if (content.subtitle) {
        const el = document.createElement('h2');
        el.className = 'draggable text-2xl mt-4';
        el.dataset.key = 'subtitle';
        el.innerHTML = content.subtitle;
        Object.assign(el.style, slidePositions.subtitle?.styles || { color: 'var(--text-secondary)', fontSize: '1.5rem' });
         if(slidePositions.subtitle?.position) { el.style.position = 'absolute'; Object.assign(el.style, slidePositions.subtitle.position); wrapper.appendChild(el); } else { textTarget.appendChild(el); }
      }
      if (Array.isArray(content.points)) {
        const items = content.points.map(p => `<li class="flex items-start"><span class="text-2xl mr-3" style="color: var(--brand-primary);">&check;</span><span class="text-lg">${p}</span></li>`).join('');
        const el = document.createElement('ul');
        el.className = 'draggable mt-6 space-y-3 max-w-2xl';
        el.dataset.key = 'points';
        el.innerHTML = items;
         if(slidePositions.points?.position) { el.style.position = 'absolute'; Object.assign(el.style, slidePositions.points.position); wrapper.appendChild(el); } else { textTarget.appendChild(el); }
      }
      
      targetContainer.appendChild(wrapper);

      if (targetContainer === dom.main.slideContainer) {
        targetContainer.querySelectorAll('.draggable').forEach(el => makeDraggable(el));
        updateSlideControls(index);
      }
    };


    const makeDraggable = (element) => {
      let pos1=0,pos2=0,pos3=0,pos4=0;
      const dragMouseDown = (e) => {
        if (e.target.closest('#text-command-center') || e.target.isContentEditable) return;
        e.preventDefault(); saveState();
        if (window.getComputedStyle(element).position !== 'absolute') {
          const rect = element.getBoundingClientRect(); const parentRect = element.offsetParent.getBoundingClientRect();
          element.style.position = 'absolute'; element.style.left = `${rect.left - parentRect.left}px`; element.style.top = `${rect.top - parentRect.top}px`; element.style.width = `${rect.width}px`; element.style.transform = 'none';
        }
        pos3 = e.clientX; pos4 = e.clientY; document.onmouseup = closeDragElement; document.onmousemove = elementDrag;
      };
      const elementDrag = (e) => {
        e.preventDefault(); const parentRect = element.offsetParent.getBoundingClientRect();
        pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY;
        let newTop = Math.max(0, Math.min(element.offsetTop - pos2, parentRect.height - element.offsetHeight));
        let newLeft = Math.max(0, Math.min(element.offsetLeft - pos1, parentRect.width - element.offsetWidth));
        element.style.top = `${newTop}px`; element.style.left = `${newLeft}px`;
      };
      const closeDragElement = () => {
        document.onmouseup = null; document.onmousemove = null;
        const slideIndex = appState.currentSlideIndex; const key = element.dataset.key;
        if (!appState.elementPositions[slideIndex]) appState.elementPositions[slideIndex] = {};
        if (!appState.elementPositions[slideIndex][key]) appState.elementPositions[slideIndex][key] = {};
        appState.elementPositions[slideIndex][key].position = { left: element.style.left, top: element.style.top, width: `${element.offsetWidth}px`, height: `${element.offsetHeight}px` };
      };
      element.onmousedown = dragMouseDown;
    };

    const updateSlideControls = (index) => {
      dom.main.slideNumberInput.value = index + 1;
      dom.main.totalSlides.textContent = appState.webinarScript.length;
      dom.main.prevBtn.disabled = index === 0;
      dom.main.nextBtn.disabled = index >= appState.webinarScript.length - 1;
    };

    // --- EXPORT FUNCTIONS ---
    const downloadScriptAsDoc = () => {
      if (!appState.speakerNotes.length) return showToast('Kein Skript zum Herunterladen vorhanden.', 'error');
      let scriptContent = `<h1>Webinar-Skript für ${appState.moderatorName}</h1>`;
      appState.speakerNotes.forEach((note, i) => { 
          const slideTitle = appState.webinarScript[i]?.content?.title || `Folie ${i+1}`;
          scriptContent += `<br><hr><br><h2>${slideTitle}</h2><p>${note}</p>`; 
      });
      const sourceHTML = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Webinar Skript</title></head><body>${scriptContent}</body></html>`;
      const a = document.createElement('a'); a.href = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML); a.download = 'webinar-skript.doc'; document.body.appendChild(a); a.click(); a.remove();
    };

    const downloadPptx = async () => {
      if (!window.PptxGenJS) return showToast('Export-Bibliothek (PptxGenJS) nicht geladen.', 'error');
      if (!appState.webinarScript.length) return showToast('Bitte zuerst ein Webinar generieren.', 'error');
      dom.buttons.downloadPptx.disabled = true; dom.buttons.downloadPptx.textContent = 'Exportiere...';

      const pptx = new PptxGenJS(); pptx.layout = 'LAYOUT_16x9';
      const W = 10, H = 5.625;
      
      for (let i = 0; i < appState.webinarScript.length; i++) {
        const slideData = appState.webinarScript[i];
        const s = pptx.addSlide(); s.background = { color: appState.theme === 'dark' ? '120c18' : 'FFFFFF' };
        const c = slideData.content || {};
        const layout = slideData.layout || 'default';

        const textDefaults = { fontFace: 'Open Sans', color: appState.theme === 'dark' ? 'FFFFFF' : '000000' };
        const titleDefaults = { fontFace: 'Montserrat', bold: true, color: '6a0dad' };

        if (layout.startsWith('split')) {
            const isTextLeft = layout === 'split_left_text';
            const textX = isTextLeft ? 0.5 : 5.2;
            const imageX = isTextLeft ? 5.2 : 0.5;

            if (c.title) s.addText(c.title, { x: textX, y: 1.5, w: 4.3, h: 1, align: 'left', fontSize: 28, ...titleDefaults });
            if (c.subtitle) s.addText(c.subtitle, { x: textX, y: 2.5, w: 4.3, h: 1, align: 'left', fontSize: 18, color: appState.theme === 'dark' ? 'A0AEC0' : '4A5568' });
            if (Array.isArray(c.points)) s.addText(c.points.join('\n'), { x: textX, y: 3.0, w: 4.3, h: 2, fontSize: 14, ...textDefaults, bullet:{type:'char', char:'✔', style:{color:'6a0dad'}} });
            
            s.addShape(pptx.ShapeType.rect, { x: imageX, y: 1, w: 4.3, h: 3.6, fill: { color: 'F1F1F1' } });
            s.addText(slideData.image_prompt || 'Bild hier einfügen', { x: imageX, y: 1, w: 4.3, h: 3.6, align: 'center', valign: 'middle', color: '888888', fontSize: 12 });
        } else { // default
            if (c.title) s.addText(c.title, { x: 0.5, y: 1.5, w: 9, h: 1, align: 'center', fontSize: 36, ...titleDefaults });
            if (c.subtitle) s.addText(c.subtitle, { x: 0.5, y: 2.5, w: 9, h: 1, align: 'center', fontSize: 24, color: appState.theme === 'dark' ? 'A0AEC0' : '4A5568' });
            if (Array.isArray(c.points)) s.addText(c.points.join('\n'), { x: 1.5, y: 3.0, w: 7, h: 2, fontSize: 18, ...textDefaults, align: 'center', bullet:{type:'char', char:'✔', style:{color:'6a0dad'}} });
        }

        const logoOpts = { x: (parseFloat(dom.sidebar.logoX.value)/100)*W, y: (parseFloat(dom.sidebar.logoY.value)/100)*H, w: (parseFloat(dom.sidebar.logoSize.value)/100)*(W*0.3) };
        if (appState.logoUrl) s.addImage({ data: appState.logoUrl, ...logoOpts });
        else if (appState.moderatorName) s.addText(appState.moderatorName, { ...logoOpts, fontSize: 8, color: appState.theme === 'dark' ? 'A0AEC0' : '4A5568' });
        
        s.addText(`${i+1}`, { x: 9.5, y: 5.2, w: 0.4, h: 0.3, fontSize: 10, color: '888888', align: 'right' });
        if (i > 0 && i % 25 === 0) await yieldToUI();
      }

      try {
        await pptx.writeFile({ fileName: `${appState.moderatorName || 'Webinar'}-Praesentation.pptx` });
        showToast('PPTX-Datei erfolgreich exportiert!', 'success');
      } catch (err) {
        console.error('PPTX Export Fehler:', err); showToast(`Export fehlgeschlagen: ${err.message}`, 'error');
      } finally {
        dom.buttons.downloadPptx.disabled = false; dom.buttons.downloadPptx.textContent = 'Export (.pptx)';
      }
    };

    // --- TEXT-EDITOR UI ---
    const showTextEditor = (el) => {
      activeTextElement = el; const rect = el.getBoundingClientRect(); const editor = dom.textEditor.commandCenter;
      editor.style.top = `${window.scrollY + rect.top - editor.offsetHeight - 5}px`; editor.style.left = `${window.scrollX + rect.left + (rect.width/2) - (editor.offsetWidth/2)}px`; editor.classList.add('show');
      dom.textEditor.fontFamily.value = el.style.fontFamily.replace(/\"/g, '') || 'Montserrat';
      dom.textEditor.fontSize.value = parseInt(el.style.fontSize) || 48;
      dom.textEditor.fontColor.value = rgbToHex(el.style.color || '#000000');
    };
    const hideTextEditor = () => { dom.textEditor.commandCenter.classList.remove('show'); activeTextElement = null; };
    const applyTextStyle = (style, value) => {
      if (!activeTextElement) return; saveState(); activeTextElement.style[style] = value;
      const slideIndex = appState.currentSlideIndex; const key = activeTextElement.dataset.key;
      if (!appState.elementPositions[slideIndex]) appState.elementPositions[slideIndex] = {};
      if (!appState.elementPositions[slideIndex][key]) appState.elementPositions[slideIndex][key] = {};
      if (!appState.elementPositions[slideIndex][key].styles) appState.elementPositions[slideIndex][key].styles = {};
      appState.elementPositions[slideIndex][key].styles[style] = value;
    };

    // --- EVENT LISTENERS ---
    dom.buttons.goToStep2.addEventListener('click', async () => {
      const required = [dom.inputs.apiKeyInput, dom.inputs.moderatorName, dom.inputs.webinarName, dom.inputs.webinarBenefit, dom.inputs.heroStory, dom.inputs.product, dom.inputs.audience];
      if (required.some(input => !input.value?.trim() && !(input.files?.length))) return showToast('Bitte alle erforderlichen Felder ausfüllen und Dateien hochladen.', 'error');
      try {
        Object.assign(appState, {
          apiKey: dom.inputs.apiKeyInput.value,
          moderatorName: dom.inputs.moderatorName.value,
          webinarName: dom.inputs.webinarName.value,
          webinarBenefit: dom.inputs.webinarBenefit.value,
          giftPromise: dom.inputs.giftPromise.value,
          callToAction: dom.inputs.callToAction.value,
          heroStoryContent: await readFileAsText(dom.inputs.heroStory.files[0]),
          productContent: await readFileAsText(dom.inputs.product.files[0]),
          audienceContent: await readFileAsText(dom.inputs.audience.files[0]),
          faqContent: await readFileAsText(dom.inputs.faq.files[0]),
          productModules: dom.inputs.productModules.value.split(',').map(s => s.trim()).filter(Boolean),
          bonusInfo: dom.inputs.bonusInfo.value.split(',').map(s => s.trim()).filter(Boolean),
          pricingInfo: dom.inputs.pricingInfo.value.split(',').map(s => s.trim()).filter(Boolean),
          guarantee: dom.inputs.guaranteeDays.value !== '0' ? `${dom.inputs.guaranteeDays.value} Tage Geld-zurück-Garantie` : 'Keine'
        });
        appState.currentStep = 2; updateStepUI();
      } catch (e) { showToast(`Fehler beim Lesen der Dateien: ${e.message}`, 'error'); }
    });

    dom.buttons.backToStep1.addEventListener('click', () => { appState.currentStep = 1; updateStepUI(); });
    dom.buttons.generateAndPreview.addEventListener('click', generateWebinar);
    dom.buttons.backToStep2.addEventListener('click', () => { appState.currentStep = 2; updateStepUI(); });
    dom.sidebar.undoBtn.addEventListener('click', undoLastAction);
    dom.sidebar.slideCountSlider.addEventListener('input', e => { appState.slideCount = parseInt(e.target.value, 10); dom.sidebar.slideCountDisplay.textContent = appState.slideCount; });
    dom.sidebar.logoUpload.addEventListener('change', async e => { if (e.target.files[0]) { appState.logoUrl = await getImageUrl(e.target.files[0]); if (appState.webinarScript.length) renderSlide(appState.currentSlideIndex); } });
    dom.sidebar.themeLightBtn.addEventListener('click', () => applyTheme('light'));
    dom.sidebar.themeDarkBtn.addEventListener('click', () => applyTheme('dark'));
    ['input','change'].forEach(evt => { [dom.sidebar.logoX, dom.sidebar.logoY, dom.sidebar.logoSize].forEach(el => el.addEventListener(evt, () => {if(appState.webinarScript.length) renderSlide(appState.currentSlideIndex)})); });
    dom.main.prevBtn.addEventListener('click', () => { if (appState.currentSlideIndex > 0) renderSlide(appState.currentSlideIndex - 1); });
    dom.main.nextBtn.addEventListener('click', () => { if (appState.currentSlideIndex < appState.webinarScript.length - 1) renderSlide(appState.currentSlideIndex + 1); });
    dom.main.slideNumberInput.addEventListener('change', e => { const newIndex = parseInt(e.target.value, 10) - 1; if (newIndex >= 0 && newIndex < appState.webinarScript.length) renderSlide(newIndex); else e.target.value = appState.currentSlideIndex + 1; });
    dom.buttons.downloadScript.addEventListener('click', downloadScriptAsDoc);
    dom.buttons.downloadPptx.addEventListener('click', downloadPptx);
    dom.buttons.fullscreenBtn.addEventListener('click', toggleModalFullscreen);
    dom.main.fullscreenOverlay.addEventListener('click', (e) => { if (e.target === dom.main.fullscreenOverlay) toggleModalFullscreen(); });
    dom.inputs.addressFormDu.addEventListener('click', () => applyAddressForm('du'));
    dom.inputs.addressFormSie.addEventListener('click', () => applyAddressForm('sie'));

    dom.main.slideContainer.addEventListener('click', e => {
      const target = e.target.closest('.draggable');
      if (target && (target.tagName === 'H1' || target.tagName === 'H2')) {
        target.setAttribute('contenteditable', 'true');
        target.focus();
        showTextEditor(target);
      }
    });

    document.addEventListener('click', e => {
      if (activeTextElement && !dom.textEditor.commandCenter.contains(e.target) && !activeTextElement.contains(e.target)) {
        const slideIndex = appState.currentSlideIndex;
        const key = activeTextElement.dataset.key;
        const newContent = activeTextElement.innerHTML;
        
        if (appState.webinarScript[slideIndex]?.content?.[key] !== newContent) {
            saveState();
            appState.webinarScript[slideIndex].content[key] = newContent;
            showToast('Text aktualisiert', 'info', 1500);
        }

        activeTextElement.removeAttribute('contenteditable');
        hideTextEditor();
      }
    });

    dom.textEditor.fontFamily.addEventListener('change', e => applyTextStyle('fontFamily', e.target.value));
    dom.textEditor.fontSize.addEventListener('input', e => applyTextStyle('fontSize', `${e.target.value}px`));
    dom.textEditor.fontColor.addEventListener('input', e => applyTextStyle('color', e.target.value));
    dom.textEditor.boldBtn.addEventListener('click', () => applyTextStyle('fontWeight', activeTextElement.style.fontWeight === 'bold' ? 'normal' : 'bold'));
    dom.textEditor.italicBtn.addEventListener('click', () => applyTextStyle('fontStyle', activeTextElement.style.fontStyle === 'italic' ? 'normal' : 'italic'));

    // --- INITIALIZATION ---
    updateStepUI();
    applyTheme(appState.theme);
    applyAddressForm(appState.addressForm);
  });
</script>
</body>
</html>
