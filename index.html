<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KI Webinar-Assistent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pptxgenjs/3.12.0/pptxgen.bundle.js"></script>
    <style>
        :root {
            --brand-primary: #6a0dad;
            --brand-secondary: #ffd700;
            --brand-dark: #120c18;
            --text-light: #f7fafc;
            --text-dark: #1a202c;
            --success: #28a745;
            --error: #dc2626;
        }

        body {
            background-color: #f0f2f5;
            font-family: 'Open Sans', sans-serif;
            color: var(--text-dark);
        }

        h1, h2, h3, .font-title {
            font-family: 'Montserrat', sans-serif;
        }
        
        /* Shiripour-Stil Anpassungen */
        .shiripour-gradient-bg {
            background: linear-gradient(135deg, var(--brand-primary) 0%, #8a2be2 100%);
        }
        .shiripour-gradient-text {
            background: linear-gradient(135deg, var(--brand-primary) 0%, #c4b5fd 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .cta-button {
            background: linear-gradient(to right, var(--brand-secondary), #ffeb3b);
            color: #333;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            border-radius: 8px;
            text-transform: uppercase;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px 0 rgba(0,0,0,0.1);
            border-bottom: 3px solid #e0b400;
        }
        .cta-button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 20px 0 rgba(0,0,0,0.2);
        }
        .input-field:focus {
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(106, 13, 173, 0.2);
            outline: none;
        }
        .input-file {
            width: 100%;
            font-size: 0.875rem;
            color: #4a5568;
            margin-top: 0.25rem;
        }
        .input-file::file-selector-button {
            margin-right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            border: 0;
            font-size: 0.875rem;
            font-weight: 600;
            background-color: #f3e8ff;
            color: #6b21a8;
        }
         .input-file::file-selector-button:hover {
             background-color: #e9d5ff;
         }


        /* Slide-Vorschau */
        .slide-container {
            aspect-ratio: 16 / 9;
            width: 100%;
            max-width: 1100px;
            box-shadow: 0 15px 45px rgba(0,0,0,0.2);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
            background-color: #fff; /* Fallback background */
        }
        .slide-hidden {
            opacity: 0;
            transform: scale(0.95);
        }
        .slide-container.theme-light {
            --bg-slide: #ffffff;
            --text-primary: #000000;
            --text-secondary: #4a5568;
            --border-color: #e2e8f0;
        }
        .slide-container.theme-dark {
            --bg-slide: var(--brand-dark);
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --border-color: #4a5568;
        }
        .slide-content-wrapper {
            width: 100%;
            height: 100%;
            background-color: var(--bg-slide);
            color: var(--text-primary);
            position: relative; /* Wichtig für absolute Positionierung der Kinder */
        }
        [contenteditable]:hover {
            outline: 2px dashed var(--brand-primary);
            cursor: text;
        }
        [contenteditable]:focus {
            outline: 2px solid var(--brand-primary);
            background-color: rgba(106, 13, 173, 0.1);
            box-shadow: 0 0 10px rgba(106, 13, 173, 0.3);
        }
        .draggable {
            cursor: move;
            user-select: none;
        }
        .slide-footer, .slide-logo {
            position: absolute;
            font-size: 0.75rem;
            color: var(--text-secondary);
            z-index: 10;
        }
        .slide-footer { bottom: 2%; right: 3%; }
        .slide-logo { top: 2%; left: 3%; max-width: 150px; position: absolute;}
        .slide-logo img { width: 100%; height: auto; }
        
        .slide-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            border-radius: 0;
            box-shadow: none;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }
         .slide-container.fullscreen .slide-content-wrapper {
             width: 90vw;
             height: calc(90vw / (16/9));
             max-height: 90vh;
         }


        /* UI Komponenten */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--brand-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Step Progress Bar */
        .step-progress { display: flex; justify-content: space-between; position: relative; width: 100%; max-width: 600px; margin: 2rem auto; }
        .step-progress::before { content: ''; position: absolute; top: 15px; left: 10%; right: 10%; height: 2px; background-color: #ccc; z-index: 0; }
        #step-progress-bar { position: absolute; top: 15px; left: 10%; width: 0%; height: 2px; background: var(--brand-primary); z-index: 0; transition: width 0.5s ease; }
        .step { text-align: center; z-index: 1; }
        .step-circle { width: 30px; height: 30px; border-radius: 50%; background-color: #ccc; color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; transition: background-color 0.3s; margin: 0 auto; }
        .step.active .step-circle { background-color: var(--brand-primary); }
        .step.completed .step-circle { background-color: var(--success); }
        .step-label { margin-top: 0.5rem; font-size: 0.8rem; color: #666; transition: color 0.3s; }
        .step.active .step-label, .step.completed .step-label { color: #000; font-weight: bold; }

        /* Lade-Overlay */
        #generation-status {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 50;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(5px);
        }
        .theme-light #generation-status {
             background-color: rgba(255, 255, 255, 0.8);
        }
        .theme-dark #generation-status {
             background-color: rgba(18, 12, 24, 0.8);
        }
        #generation-status.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            z-index: 10000;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: var(--success); }
        .toast.error { background-color: var(--error); }
        
        /* Text Command Center */
        #text-command-center {
            position: absolute;
            display: none;
            background-color: #333;
            color: white;
            padding: 5px;
            border-radius: 6px;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            gap: 5px;
        }
        #text-command-center.show {
            display: flex;
        }
        #text-command-center button, #text-command-center select, #text-command-center input {
            background-color: #555;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        #text-command-center button:hover {
            background-color: var(--brand-primary);
        }
    </style>
</head>
<body class="flex flex-col md:flex-row min-h-screen">

    <!-- Sidebar -->
    <aside class="sidebar w-full md:w-96 p-6 bg-white shadow-lg md:h-screen md:sticky top-0 overflow-y-auto transition-all duration-300">
        <h2 class="text-3xl font-black mb-6 shiripour-gradient-text">Steuerzentrale</h2>

        <!-- Step 2 Controls -->
        <div id="step2-controls" class="hidden space-y-6">
            <button id="back-to-step1-btn" class="w-full bg-gray-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-600 transition-colors">&larr; Zurück zu Schritt 1</button>
            <div>
                <label for="slide-count-slider" class="block text-sm font-medium">Folienanzahl: <span id="slide-count-display" class="font-bold">200</span></label>
                <input type="range" id="slide-count-slider" min="10" max="200" value="200" step="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2">
            </div>
            <div>
                <label class="block text-sm font-medium">Hintergrund</label>
                <div class="mt-1 flex rounded-md shadow-sm">
                    <button id="theme-light-btn" class="theme-btn flex-1 rounded-l-md px-4 py-2 text-sm border border-gray-300" data-theme="light">Hell</button>
                    <button id="theme-dark-btn" class="theme-btn flex-1 rounded-r-md px-4 py-2 text-sm border border-gray-300" data-theme="dark">Dunkel</button>
                </div>
            </div>
             <div>
                <label class="block text-sm font-medium">Logo Upload</label>
                <input type="file" id="logo-upload" accept="image/*" class="input-file">
            </div>
            <button id="generate-and-preview-btn" class="w-full cta-button py-3 px-4">Webinar generieren (Schritt 3) &rarr;</button>
        </div>

        <!-- Step 3 Controls -->
        <div id="step3-controls" class="hidden space-y-4">
             <button id="back-to-step2-btn" class="w-full bg-gray-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-600 transition-colors">&larr; Zurück zu Schritt 2</button>
            <h3 class="font-bold text-lg pt-4">Folien-Editor</h3>
             <button id="undo-btn" class="w-full bg-gray-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-600 transition-colors">&larr; Rückgängig</button>
            <div>
                 <label class="block text-sm font-medium">Logo Position & Größe</label>
                 <input type="range" id="logo-x" min="0" max="95" value="3" class="w-full mt-1" title="X-Position (%)">
                 <input type="range" id="logo-y" min="0" max="95" value="2" class="w-full" title="Y-Position (%)">
                 <input type="range" id="logo-size" min="5" max="30" value="15" class="w-full" title="Größe (%)">
            </div>
             <p class="text-xs text-gray-500 italic">Klicke auf Textelemente in der Vorschau, um sie zu bearbeiten und zu verschieben.</p>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col items-center justify-start p-4 md:p-8">
        
        <!-- Step Progress Bar -->
        <div class="step-progress">
            <div id="step-progress-bar"></div>
            <div id="step1" class="step"><div class="step-circle">1</div><div class="step-label">Inhalt & KI</div></div>
            <div id="step2" class="step"><div class="step-circle">2</div><div class="step-label">Design</div></div>
            <div id="step3" class="step"><div class="step-circle">3</div><div class="step-label">Vorschau & Export</div></div>
        </div>
        
        <!-- Content Area -->
        <div id="main-content-area" class="w-full mt-4">

            <!-- Step 1: Inputs -->
            <div id="step1-content" class="w-full max-w-4xl p-6 bg-white rounded-lg shadow-xl mx-auto">
                <h3 class="font-title font-black text-2xl mb-6 text-center">Schritt 1: Gib der KI Futter</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label for="api-key-input" class="block text-sm font-medium">Dein Google AI API Key</label>
                            <input type="password" id="api-key-input" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm input-field" placeholder="Erforderlich für die KI-Generierung" required>
                        </div>
                        <div>
                            <label for="moderator-name-input" class="block text-sm font-medium">Dein Name / Moderator</label>
                            <input type="text" id="moderator-name-input" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm input-field" placeholder="z.B. Said Shiripour" required>
                        </div>
                        <div>
                            <label for="hero-story-upload" class="block text-sm font-medium">1. Deine Heldenstory (TXT)</label>
                            <input type="file" id="hero-story-upload" accept=".txt" class="input-file" required>
                        </div>
                        <div>
                            <label for="product-upload" class="block text-sm font-medium">2. Deine Produktinfos (TXT)</label>
                            <input type="file" id="product-upload" accept=".txt" class="input-file" required>
                        </div>
                        <div>
                            <label for="audience-upload" class="block text-sm font-medium">3. Deine Zielgruppe (TXT)</label>
                            <input type="file" id="audience-upload" accept=".txt" class="input-file" required>
                        </div>
                         <div>
                            <label for="faq-upload" class="block text-sm font-medium">4. Deine FAQs (MD)</label>
                            <input type="file" id="faq-upload" accept=".md,.txt" class="input-file">
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="product-modules" class="block text-sm font-medium">Produkt-Module (kommagetrennt)</label>
                            <input type="text" id="product-modules" class="w-full p-2 border border-gray-300 rounded-md shadow-sm input-field" placeholder="Modul 1, Modul 2, ...">
                        </div>
                        <div>
                            <label for="bonus-info" class="block text-sm font-medium">Bonus-Angebote (kommagetrennt)</label>
                            <input type="text" id="bonus-info" class="w-full p-2 border border-gray-300 rounded-md shadow-sm input-field" placeholder="Bonus 1, Bonus 2, ...">
                        </div>
                        <div>
                            <label for="pricing-info" class="block text-sm font-medium">Preisstaffelung (kommagetrennt)</label>
                            <input type="text" id="pricing-info" class="w-full p-2 border border-gray-300 rounded-md shadow-sm input-field" placeholder="Preis 1, Preis 2, ...">
                        </div>
                        <div>
                            <label for="guarantee-days" class="block text-sm font-medium">Garantie</label>
                            <select id="guarantee-days" class="w-full p-2 border border-gray-300 rounded-md shadow-sm input-field">
                                <option value="0">Keine Garantie</option>
                                <option value="14">14 Tage</option>
                                <option value="30">30 Tage</option>
                                <option value="60">60 Tage</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button id="go-to-step2-btn" class="w-full mt-8 cta-button py-3 px-4">Weiter zu Schritt 2 &rarr;</button>
            </div>
            
            <!-- Step 3: Preview -->
            <div id="preview-area" class="w-full flex flex-col items-center justify-center hidden relative">
                <div id="slide-container" class="slide-container">
                    <!-- Slide content is rendered here -->
                </div>
                <div class="flex items-center justify-center mt-6 space-x-2 sm:space-x-4">
                    <button id="prev-slide" class="shiripour-gradient-bg text-white py-2 px-6 rounded-lg font-bold transition-transform hover:scale-105 disabled:opacity-50">&larr;</button>
                    <div class="text-lg font-semibold">
                        <input type="number" id="slide-number-input" min="1" class="w-16 text-center p-1 border border-gray-300 rounded-md input-field" value="1">
                        / <span id="total-slides">0</span>
                    </div>
                    <button id="next-slide" class="shiripour-gradient-bg text-white py-2 px-6 rounded-lg font-bold transition-transform hover:scale-105">&rarr;</button>
                    <button id="fullscreen-btn" class="shiripour-gradient-bg text-white py-2 px-6 rounded-lg font-bold transition-transform hover:scale-105">Vollbild</button>
                    <button id="download-script-btn" class="shiripour-gradient-bg text-white py-2 px-6 rounded-lg font-bold transition-transform hover:scale-105 hidden">Skript (.doc)</button>
                    <button id="download-pptx-btn" class="cta-button py-2 px-6">Export (.pptx)</button>
                </div>
                 <div id="generation-status" class="hidden">
                    <div class="loader mx-auto"></div>
                    <p id="progress-text" class="text-sm text-gray-600 mt-2">Generiere Webinar...</p>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Text Command Center -->
    <div id="text-command-center">
        <select id="font-family-select">
            <option value="Montserrat">Montserrat</option>
            <option value="Open Sans">Open Sans</option>
        </select>
        <input type="number" id="font-size-input" min="10" max="120" value="48" class="w-16">
        <input type="color" id="font-color-input" value="#000000">
        <button id="font-bold-btn"><b>B</b></button>
        <button id="font-italic-btn"><i>I</i></button>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- STATE MANAGEMENT ---
    let appState = {
        currentStep: 1,
        webinarScript: [],
        speakerNotes: [],
        currentSlideIndex: 0,
        apiKey: '',
        moderatorName: '',
        slideCount: 200,
        theme: 'light',
        logoUrl: '',
        heroStoryContent: '',
        productContent: '',
        audienceContent: '',
        faqContent: '',
        productModules: [],
        bonusInfo: [],
        pricingInfo: [],
        guarantee: '',
        elementPositions: {},
        history: [], // For undo
    };

    // --- DOM Elements ---
    const dom = {
        sidebar: {
            step2Controls: document.getElementById('step2-controls'),
            step3Controls: document.getElementById('step3-controls'),
            slideCountSlider: document.getElementById('slide-count-slider'),
            slideCountDisplay: document.getElementById('slide-count-display'),
            themeLightBtn: document.getElementById('theme-light-btn'),
            themeDarkBtn: document.getElementById('theme-dark-btn'),
            logoUpload: document.getElementById('logo-upload'),
            logoX: document.getElementById('logo-x'),
            logoY: document.getElementById('logo-y'),
            logoSize: document.getElementById('logo-size'),
            undoBtn: document.getElementById('undo-btn'),
        },
        main: {
            step1Content: document.getElementById('step1-content'),
            previewArea: document.getElementById('preview-area'),
            slideContainer: document.getElementById('slide-container'),
            prevBtn: document.getElementById('prev-slide'),
            nextBtn: document.getElementById('next-slide'),
            slideNumberInput: document.getElementById('slide-number-input'),
            totalSlides: document.getElementById('total-slides'),
            generationStatus: document.getElementById('generation-status'),
            progressText: document.getElementById('progress-text'),
        },
        steps: {
            step1: document.getElementById('step1'),
            step2: document.getElementById('step2'),
            step3: document.getElementById('step3'),
            progressBar: document.getElementById('step-progress-bar'),
        },
        inputs: {
            apiKeyInput: document.getElementById('api-key-input'),
            moderatorName: document.getElementById('moderator-name-input'),
            heroStory: document.getElementById('hero-story-upload'),
            product: document.getElementById('product-upload'),
            audience: document.getElementById('audience-upload'),
            faq: document.getElementById('faq-upload'),
            productModules: document.getElementById('product-modules'),
            bonusInfo: document.getElementById('bonus-info'),
            pricingInfo: document.getElementById('pricing-info'),
            guaranteeDays: document.getElementById('guarantee-days'),
        },
        buttons: {
            goToStep2: document.getElementById('go-to-step2-btn'),
            backToStep1: document.getElementById('back-to-step1-btn'),
            backToStep2: document.getElementById('back-to-step2-btn'),
            generateAndPreview: document.getElementById('generate-and-preview-btn'),
            downloadScript: document.getElementById('download-script-btn'),
            downloadPptx: document.getElementById('download-pptx-btn'),
            fullscreenBtn: document.getElementById('fullscreen-btn'),
        },
        textEditor: {
            commandCenter: document.getElementById('text-command-center'),
            fontFamily: document.getElementById('font-family-select'),
            fontSize: document.getElementById('font-size-input'),
            fontColor: document.getElementById('font-color-input'),
            boldBtn: document.getElementById('font-bold-btn'),
            italicBtn: document.getElementById('font-italic-btn'),
        }
    };
    
    let activeTextElement = null;

    // --- HISTORY / UNDO MANAGEMENT ---
    const saveState = () => {
        // Deep copy of positions and script to avoid mutation issues
        appState.history.push(JSON.parse(JSON.stringify({
            elementPositions: appState.elementPositions,
            webinarScript: appState.webinarScript
        })));
    };

    const undoLastAction = () => {
        if (appState.history.length > 1) { // Always keep initial state
            appState.history.pop(); // Remove current state
            const previousState = appState.history[appState.history.length - 1];
             // Restore previous state
            appState.elementPositions = JSON.parse(JSON.stringify(previousState.elementPositions));
            appState.webinarScript = JSON.parse(JSON.stringify(previousState.webinarScript));
            renderSlide(appState.currentSlideIndex);
            showToast('Letzte Aktion rückgängig gemacht', 'info');
        } else {
            showToast('Keine weiteren Aktionen zum Rückgängigmachen', 'info');
        }
    };


    // --- CORE LOGIC ---
    
    const readFileAsText = (file) => {
        return new Promise((resolve, reject) => {
            if (!file) return resolve('');
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = e => reject(e);
            reader.readAsText(file);
        });
    };

    const getImageUrl = (file) => {
        return new Promise((resolve) => {
            if (!file) return resolve('');
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(file);
        });
    };

    const showToast = (message, type = 'success') => {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 3000);
        }, 3000);
    };

    const updateStepUI = () => {
        const { currentStep } = appState;
        
        dom.main.step1Content.classList.add('hidden');
        dom.sidebar.step2Controls.classList.add('hidden');
        dom.main.previewArea.classList.add('hidden');
        dom.sidebar.step3Controls.classList.add('hidden');

        if (currentStep === 1) dom.main.step1Content.classList.remove('hidden');
        if (currentStep === 2) dom.sidebar.step2Controls.classList.remove('hidden');
        if (currentStep === 3) {
            dom.main.previewArea.classList.remove('hidden');
            dom.sidebar.step3Controls.classList.remove('hidden');
        }
        
        Object.values(dom.steps).forEach(el => el.classList?.remove('active', 'completed'));
        for (let i = 1; i <= currentStep; i++) {
            dom.steps[`step${i}`].classList.add(i < currentStep ? 'completed' : 'active');
        }
        dom.steps.progressBar.style.width = `${((currentStep - 1) / 2) * 80}%`;
    };

    const applyTheme = (theme) => {
        appState.theme = theme;
        dom.main.slideContainer.className = `slide-container theme-${theme}`;
        dom.main.previewArea.classList.remove('theme-light', 'theme-dark');
        dom.main.previewArea.classList.add(`theme-${theme}`);
        
        dom.sidebar.themeLightBtn.classList.toggle('shiripour-gradient-bg', theme === 'light');
        dom.sidebar.themeLightBtn.classList.toggle('text-white', theme === 'light');
        dom.sidebar.themeDarkBtn.classList.toggle('shiripour-gradient-bg', theme === 'dark');
        dom.sidebar.themeDarkBtn.classList.toggle('text-white', theme === 'dark');
        if (appState.webinarScript.length > 0) renderSlide(appState.currentSlideIndex);
    };

    const callGeminiApi = async (prompt) => {
        if (!appState.apiKey) {
            showToast('API Key fehlt. Bitte in Schritt 1 eingeben.', 'error');
            throw new Error("API Key is missing.");
        }

        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${appState.apiKey}`;
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { responseMimeType: "application/json" }
        };

        const maxRetries = 3;
        let lastError = null;

        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    return response.json();
                }

                if (response.status === 503) {
                    const delay = Math.pow(2, i) * 2000; // 2s, 4s, 8s
                    dom.main.progressText.textContent = `Server überlastet. Nächster Versuch in ${delay / 1000}s...`;
                    await new Promise(res => setTimeout(res, delay));
                    continue; 
                }
                
                const errorText = await response.text();
                console.error("API Error:", errorText);
                lastError = new Error(`HTTP ${response.status}: API-Fehler.`);
                break; 

            } catch (networkError) {
                lastError = networkError;
                const delay = Math.pow(2, i) * 2000;
                dom.main.progressText.textContent = `Netzwerkfehler. Nächster Versuch in ${delay / 1000}s...`;
                await new Promise(res => setTimeout(res, delay));
            }
        }
        
        throw lastError || new Error("API-Anfrage nach mehreren Versuchen fehlgeschlagen.");
    };

    const generateWebinar = async () => {
        appState.currentStep = 3;
        updateStepUI();
        dom.main.generationStatus.classList.remove('hidden');
        dom.main.progressText.textContent = 'Generiere Webinar...';
        dom.main.slideContainer.classList.add('hidden'); 
        document.querySelectorAll('#preview-area > .flex').forEach(el => el.classList.add('hidden')); 
        dom.buttons.generateAndPreview.disabled = true;

        const prompt = `
        Erstelle ein komplettes Webinar-Paket im Stil von Said Shiripour.
        Die Anzahl von ${appState.slideCount} Folien ist eine **strikte Anforderung**.
        Das Ergebnis MUSS ein **strikt valides JSON-Objekt OHNE Kommentare** mit zwei Schlüsseln sein: "slides" und "speakerNotes".

        1.  **"slides"**: Ein Array mit **genau ${appState.slideCount}** Folienobjekten.
            * Jedes Folienobjekt hat: \`type\` (String) und \`content\` (Objekt).
            * Das \`content\`-Objekt enthält:
                * \`title\`: String (Starke, kurze Headline).
                * \`subtitle\`: String (Optional, 1 kurzer Satz).
                * \`points\`: Array of Strings (Optional, NUR für 'modules', 'bonuses', 'price_reveal' Typen verwenden).
                * \`image_prompt\`: String (Optional, ein kurzer, prägnanter Prompt für eine Bild-KI).

        2.  **"speakerNotes"**: Ein Array mit **genau ${appState.slideCount}** Strings.
            * Jeder String ist das **VOLLSTÄNDIGE, AUSFORMULIERTE Sprecher-Skript** für die entsprechende Folie.

        **KONTEXT:**
        - Moderator: "${appState.moderatorName}"
        - Story: "${appState.heroStoryContent}"
        - Produkt: "${appState.productContent}"
        - Zielgruppe: "${appState.audienceContent}"
        - Module: ${appState.productModules.join(', ')}
        - Boni: ${appState.bonusInfo.join(', ')}
        - Preise: ${appState.pricingInfo.join(', ')}
        - Garantie: "${appState.guarantee}"
        - FAQs (im Format "Q: Frage... A: Antwort..."): "${appState.faqContent}"

        **SPEZIELLE ANWEISUNGEN:**
        - Verarbeite die FAQs: Erstelle für jede Frage eine Folie vom Typ 'faq_question' und für jede Antwort eine Folie vom Typ 'faq_answer'.
        - Halte die Folieninhalte kurz. Die Details gehören in die "speakerNotes".
        
        Stelle sicher, dass das finale JSON-Objekt valide ist und exakt die Struktur { "slides": [...], "speakerNotes": [...] } hat.
        `;

        try {
            const result = await callGeminiApi(prompt);
            let jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            let scriptPackage;
            try {
                jsonText = jsonText.replace(/```json\n?/, '').replace(/```$/, '').trim();
                jsonText = jsonText.replace(/,\s*([\]}])/g, '$1');
                scriptPackage = JSON.parse(jsonText);
            } catch (parseError) {
                 console.error("JSON Parsing Error:", parseError);
                 throw new Error("Ungültiges KI-Format: " + parseError.message);
            }
            
            if (scriptPackage && Array.isArray(scriptPackage.slides) && Array.isArray(scriptPackage.speakerNotes)) {
                appState.webinarScript = scriptPackage.slides;
                appState.speakerNotes = scriptPackage.speakerNotes;
                appState.history = []; // Clear history for new presentation
                saveState(); // Save initial state
                dom.buttons.downloadScript.classList.remove('hidden');
                renderSlide(0);
                showToast('Webinar erfolgreich generiert!', 'success');
            } else {
                throw new Error("Ungültiges Datenformat von der API erhalten.");
            }

        } catch (error) {
            console.error("Fehler bei der Webinar-Generierung:", error);
            showToast(`Generierung fehlgeschlagen: ${error.message}`, 'error');
            appState.currentStep = 2; 
            updateStepUI();
        } finally {
            dom.main.generationStatus.classList.add('hidden');
            dom.main.slideContainer.classList.remove('hidden');
            document.querySelectorAll('#preview-area > .flex').forEach(el => el.classList.remove('hidden'));
            dom.buttons.generateAndPreview.disabled = false;
        }
    };

    const renderSlide = (index) => {
        if (!appState.webinarScript || appState.webinarScript.length === 0) return;
        
        appState.currentSlideIndex = index;
        const slideData = appState.webinarScript[index];
        const { slideContainer } = dom.main;

        slideContainer.innerHTML = '';
        const wrapper = document.createElement('div');
        wrapper.className = 'slide-content-wrapper';
        
        const slidePositions = appState.elementPositions[index] || {};

        const createDraggable = (key, tag, classes, content, styles = {}) => {
            const el = document.createElement(tag);
            el.className = `draggable ${classes}`;
            el.dataset.key = key;
            el.innerHTML = content;

            // Apply saved styles
            if (slidePositions[key]?.styles) {
                Object.assign(el.style, slidePositions[key].styles);
            } else {
                 Object.assign(el.style, styles);
            }
            
            // Apply saved position
            if (slidePositions[key]?.position) {
                el.style.position = 'absolute';
                el.style.left = slidePositions[key].position.left;
                el.style.top = slidePositions[key].position.top;
                el.style.width = slidePositions[key].position.width;
            }
            return el;
        };
        
        const logoData = slidePositions.logo || {};
        const logoContainer = createDraggable('logo', 'div', 'slide-logo', '', logoData.styles);
        logoContainer.style.left = logoData.position?.left || `${dom.sidebar.logoX.value}%`;
        logoContainer.style.top = logoData.position?.top || `${dom.sidebar.logoY.value}%`;
        logoContainer.style.width = logoData.position?.width || `${dom.sidebar.logoSize.value}%`;

        if (appState.logoUrl) {
            logoContainer.innerHTML = `<img src="${appState.logoUrl}" alt="Logo">`;
        } else {
            logoContainer.textContent = appState.moderatorName;
        }
        wrapper.appendChild(logoContainer);

        const contentArea = document.createElement('div');
        contentArea.className = 'flex flex-col justify-center items-center text-center w-full h-full p-8 gap-4';

        const content = slideData.content;
        if (content) {
            if (content.title) {
                const el = createDraggable('title', 'h1', 'font-title text-4xl font-black shiripour-gradient-text text-center', content.title, { fontFamily: 'Montserrat', fontSize: '3rem', fontWeight: '900'});
                if (!slidePositions.title?.position) contentArea.appendChild(el); else wrapper.appendChild(el);
            }
            if (content.subtitle) {
                 const el = createDraggable('subtitle', 'h2', 'text-2xl mt-4 text-center', content.subtitle, { color: 'var(--text-secondary)', fontSize: '1.5rem' });
                 if (!slidePositions.subtitle?.position) contentArea.appendChild(el); else wrapper.appendChild(el);
            }
            if (content.points) {
                let pointsHtml = '';
                content.points.forEach(p => pointsHtml += `<li class="flex items-start"><span class="text-2xl mr-3" style="color: var(--brand-primary);">&check;</span><span class="text-lg">${p}</span></li>`);
                const el = createDraggable('points', 'ul', 'mt-6 space-y-3 text-left max-w-2xl', pointsHtml);
                if (!slidePositions.points?.position) contentArea.appendChild(el); else wrapper.appendChild(el);
            }
            if (content.image_prompt) {
                const el = createDraggable('image', 'div', 'w-1/2 h-1/2 bg-gray-200 flex items-center justify-center text-gray-500 rounded-lg', `<i>Bild: ${content.image_prompt}</i>`);
                 if (!slidePositions.image?.position) contentArea.appendChild(el); else wrapper.appendChild(el);
            }
        }
        wrapper.appendChild(contentArea);
        
        const footer = document.createElement('div');
        footer.className = 'slide-footer';
        footer.textContent = `${index + 1}`;
        wrapper.appendChild(footer);

        slideContainer.appendChild(wrapper);
        wrapper.querySelectorAll('.draggable').forEach(el => makeDraggable(el));
        updateSlideControls(index);
    };

    const makeDraggable = (element) => {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        
        const dragMouseDown = (e) => {
            if (e.target.closest('#text-command-center')) return;
            if (e.target.isContentEditable) return;
            
            e.preventDefault();
            saveState(); // Save state before dragging

            if (window.getComputedStyle(element).position !== 'absolute') {
                const rect = element.getBoundingClientRect();
                const parentRect = element.offsetParent.getBoundingClientRect();
                element.style.position = 'absolute';
                element.style.left = `${rect.left - parentRect.left}px`;
                element.style.top = `${rect.top - parentRect.top}px`;
                element.style.width = `${rect.width}px`;
                element.style.transform = 'none';
            }
            
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        };
        
        const elementDrag = (e) => {
            e.preventDefault();
            const parentRect = element.offsetParent.getBoundingClientRect();
            
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            
            let newTop = element.offsetTop - pos2;
            let newLeft = element.offsetLeft - pos1;

            // Containment logic
            newTop = Math.max(0, Math.min(newTop, parentRect.height - element.offsetHeight));
            newLeft = Math.max(0, Math.min(newLeft, parentRect.width - element.offsetWidth));

            element.style.top = newTop + "px";
            element.style.left = newLeft + "px";
        };

        const closeDragElement = () => {
            document.onmouseup = null;
            document.onmousemove = null;

            const slideIndex = appState.currentSlideIndex;
            const key = element.dataset.key;
            if (!appState.elementPositions[slideIndex]) appState.elementPositions[slideIndex] = {};
            if (!appState.elementPositions[slideIndex][key]) appState.elementPositions[slideIndex][key] = {};
            
            appState.elementPositions[slideIndex][key].position = {
                left: element.style.left,
                top: element.style.top,
                width: element.style.width,
            };
        };

        element.onmousedown = dragMouseDown;
    };
    
    const updateSlideControls = (index) => {
        dom.main.slideNumberInput.value = index + 1;
        dom.main.totalSlides.textContent = appState.webinarScript.length;
        dom.main.prevBtn.disabled = index === 0;
        dom.main.nextBtn.disabled = index >= appState.webinarScript.length - 1;
    };

    const downloadScriptAsDoc = () => {
         if (appState.speakerNotes.length === 0) {
            return showToast('Kein Skript zum Herunterladen vorhanden.', 'error');
        }
        let scriptContent = `<h1>Webinar-Skript für ${appState.moderatorName}</h1>`;
        appState.speakerNotes.forEach((note, index) => {
            scriptContent += `<br><hr><br><h2>Folie ${index + 1}</h2><p>${note}</p>`;
        });
        const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' "+
            "xmlns:w='urn:schemas-microsoft-com:office:word' "+
            "xmlns='http://www.w3.org/TR/REC-html40'>"+
            "<head><meta charset='utf-8'><title>Webinar Skript</title></head><body>";
       const footer = "</body></html>";
       const sourceHTML = header + scriptContent + footer;
       
       const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
       const fileDownload = document.createElement("a");
       document.body.appendChild(fileDownload);
       fileDownload.href = source;
       fileDownload.download = 'webinar-skript.doc';
       fileDownload.click();
       document.body.removeChild(fileDownload);
    }

    const downloadPptx = () => {
        if (typeof window.PptxGenJS === 'undefined') {
            return showToast('Export-Bibliothek nicht geladen. Bitte Seite neu laden.', 'error');
        }
        if (appState.webinarScript.length === 0) {
            return showToast('Bitte zuerst ein Webinar generieren.', 'error');
        }

        const pptx = new window.PptxGenJS();
        appState.webinarScript.forEach((slideData, index) => {
            const slide = pptx.addSlide();
            const content = slideData.content;
            if (!content) return;
            
            const textColor = appState.theme === 'dark' ? 'FFFFFF' : '000000';
            const primaryColor = '6a0dad';

            slide.background = { color: appState.theme === 'dark' ? '120c18' : 'FFFFFF' };
            
            if (content.title) slide.addText(content.title, { x: 0.5, y: 1.0, w: '90%', h: 1, fontSize: 32, bold: true, color: primaryColor, align: 'center' });
            if (content.subtitle) slide.addText(content.subtitle, { x: 0.5, y: 2.0, w: '90%', h: 0.75, fontSize: 22, color: textColor, align: 'center' });
            if (content.points) {
                slide.addText(content.points, { x: 1.5, y: 3.0, w: '70%', h: 3, fontSize: 18, color: textColor, bullet: true });
            }
             if (content.image_prompt) {
                slide.addText(`[BILD: ${content.image_prompt}]`, { x: 1.5, y: 3.0, w: '70%', h: 2, fontSize: 14, color: '888888', align: 'center'});
            }
            
            slide.addText(`${index + 1}`, { x: '90%', y: '90%', w: 0.5, h: 0.5, fontSize: 10, color: '888888'});
        });

        try {
            pptx.save(`${appState.moderatorName || 'Webinar'}-Praesentation.pptx`);
            showToast('PPTX-Datei erfolgreich exportiert!', 'success');
        } catch (error) {
            console.error("PPTX Export Fehler:", error);
            showToast(`PPTX Export fehlgeschlagen: ${error.message}`, 'error');
        }
    };
    
    // --- Text Editor Logic ---
    const showTextEditor = (element) => {
        activeTextElement = element;
        const rect = element.getBoundingClientRect();
        const editor = dom.textEditor.commandCenter;
        
        editor.style.top = `${rect.top - editor.offsetHeight - 5}px`;
        editor.style.left = `${rect.left + (rect.width / 2) - (editor.offsetWidth / 2)}px`;
        editor.classList.add('show');
        
        // Sync editor with element styles
        dom.textEditor.fontFamily.value = element.style.fontFamily.replace(/"/g, '') || 'Montserrat';
        dom.textEditor.fontSize.value = parseInt(element.style.fontSize) || 48;
        dom.textEditor.fontColor.value = rgbToHex(element.style.color || '#000000');
    };

    const hideTextEditor = () => {
        dom.textEditor.commandCenter.classList.remove('show');
        activeTextElement = null;
    };
    
    const applyTextStyle = (style, value) => {
        if (!activeTextElement) return;
        saveState();
        activeTextElement.style[style] = value;
        
        const slideIndex = appState.currentSlideIndex;
        const key = activeTextElement.dataset.key;
        if (!appState.elementPositions[slideIndex]) appState.elementPositions[slideIndex] = {};
        if (!appState.elementPositions[slideIndex][key]) appState.elementPositions[slideIndex][key] = {};
        if (!appState.elementPositions[slideIndex][key].styles) appState.elementPositions[slideIndex][key].styles = {};
        appState.elementPositions[slideIndex][key].styles[style] = value;
    };

    const rgbToHex = (rgb) => {
      if (!rgb || !rgb.startsWith('rgb')) return rgb;
      let sep = rgb.indexOf(",") > -1 ? "," : " ";
      rgb = rgb.substr(4).split(")")[0].split(sep);
      let r = (+rgb[0]).toString(16),
          g = (+rgb[1]).toString(16),
          b = (+rgb[2]).toString(16);
      if (r.length == 1) r = "0" + r;
      if (g.length == 1) g = "0" + g;
      if (b.length == 1) b = "0" + b;
      return "#" + r + g + b;
    }


    // --- EVENT LISTENERS ---
    
    dom.buttons.goToStep2.addEventListener('click', async () => {
        const requiredInputs = [dom.inputs.apiKeyInput, dom.inputs.moderatorName];
        if (requiredInputs.some(input => !input.value.trim())) {
            return showToast('Bitte API Key und Moderator-Namen eingeben.', 'error');
        }
        const requiredFiles = [dom.inputs.heroStory, dom.inputs.product, dom.inputs.audience];
         if (requiredFiles.some(input => input.files.length === 0)) {
            return showToast('Bitte alle drei Text-Dateien hochladen.', 'error');
        }

        try {
            appState.apiKey = dom.inputs.apiKeyInput.value;
            appState.moderatorName = dom.inputs.moderatorName.value;
            appState.heroStoryContent = await readFileAsText(dom.inputs.heroStory.files[0]);
            appState.productContent = await readFileAsText(dom.inputs.product.files[0]);
            appState.audienceContent = await readFileAsText(dom.inputs.audience.files[0]);
            appState.faqContent = await readFileAsText(dom.inputs.faq.files[0]);
            appState.productModules = dom.inputs.productModules.value.split(',').map(s => s.trim()).filter(Boolean);
            appState.bonusInfo = dom.inputs.bonusInfo.value.split(',').map(s => s.trim()).filter(Boolean);
            appState.pricingInfo = dom.inputs.pricingInfo.value.split(',').map(s => s.trim()).filter(Boolean);
            const guaranteeDays = dom.inputs.guaranteeDays.value;
            appState.guarantee = guaranteeDays !== "0" ? `${guaranteeDays} Tage Geld-zurück-Garantie` : 'Keine';

            appState.currentStep = 2;
            updateStepUI();
        } catch (error) {
            showToast(`Fehler beim Lesen der Dateien: ${error.message}`, 'error');
        }
    });
    
    dom.buttons.backToStep1.addEventListener('click', () => { appState.currentStep = 1; updateStepUI(); });
    dom.buttons.generateAndPreview.addEventListener('click', generateWebinar);
    dom.buttons.backToStep2.addEventListener('click', () => { appState.currentStep = 2; updateStepUI(); });
    dom.sidebar.undoBtn.addEventListener('click', undoLastAction);

    dom.sidebar.slideCountSlider.addEventListener('input', e => {
        appState.slideCount = parseInt(e.target.value, 10);
        dom.sidebar.slideCountDisplay.textContent = appState.slideCount;
    });
    dom.sidebar.logoUpload.addEventListener('change', async e => {
        if (e.target.files[0]) {
            appState.logoUrl = await getImageUrl(e.target.files[0]);
            if (appState.webinarScript.length > 0) renderSlide(appState.currentSlideIndex);
        }
    });
    dom.sidebar.themeLightBtn.addEventListener('click', () => applyTheme('light'));
    dom.sidebar.themeDarkBtn.addEventListener('click', () => applyTheme('dark'));
    
    ['input', 'change'].forEach(evt => {
        dom.sidebar.logoX.addEventListener(evt, () => renderSlide(appState.currentSlideIndex));
        dom.sidebar.logoY.addEventListener(evt, () => renderSlide(appState.currentSlideIndex));
        dom.sidebar.logoSize.addEventListener(evt, () => renderSlide(appState.currentSlideIndex));
    });

    dom.main.prevBtn.addEventListener('click', () => { if (appState.currentSlideIndex > 0) renderSlide(appState.currentSlideIndex - 1); });
    dom.main.nextBtn.addEventListener('click', () => { if (appState.currentSlideIndex < appState.webinarScript.length - 1) renderSlide(appState.currentSlideIndex + 1); });
    dom.main.slideNumberInput.addEventListener('change', e => {
        const newIndex = parseInt(e.target.value, 10) - 1;
        if (newIndex >= 0 && newIndex < appState.webinarScript.length) {
            renderSlide(newIndex);
        } else {
            e.target.value = appState.currentSlideIndex + 1;
        }
    });
    dom.buttons.downloadScript.addEventListener('click', downloadScriptAsDoc);
    dom.buttons.downloadPptx.addEventListener('click', downloadPptx);

    dom.buttons.fullscreenBtn.addEventListener('click', () => {
        if (!document.fullscreenElement) {
            dom.main.slideContainer.requestFullscreen().catch(err => {
                showToast(`Vollbild nicht möglich: ${err.message}`, 'error');
            });
        } else {
            document.exitFullscreen();
        }
    });
    document.addEventListener('fullscreenchange', () => {
        const isFullscreen = !!document.fullscreenElement;
        dom.main.slideContainer.classList.toggle('fullscreen', isFullscreen);
        dom.buttons.fullscreenBtn.textContent = isFullscreen ? 'Beenden' : 'Vollbild';
    });

    // Event Delegation for Text Editor and contenteditable
    dom.main.slideContainer.addEventListener('click', e => {
        if (e.target.classList.contains('draggable') && (e.target.tagName === 'H1' || e.target.tagName === 'H2')) {
            e.target.setAttribute('contenteditable', 'true');
            e.target.focus();
            showTextEditor(e.target);
        }
    });

    document.addEventListener('click', e => {
        if (activeTextElement && !dom.textEditor.commandCenter.contains(e.target) && !activeTextElement.contains(e.target)) {
            activeTextElement.removeAttribute('contenteditable');
            hideTextEditor();
        }
    });

    dom.textEditor.fontFamily.addEventListener('change', e => applyTextStyle('fontFamily', e.target.value));
    dom.textEditor.fontSize.addEventListener('input', e => applyTextStyle('fontSize', `${e.target.value}px`));
    dom.textEditor.fontColor.addEventListener('input', e => applyTextStyle('color', e.target.value));
    dom.textEditor.boldBtn.addEventListener('click', () => applyTextStyle('fontWeight', activeTextElement.style.fontWeight === 'bold' ? 'normal' : 'bold'));
    dom.textEditor.italicBtn.addEventListener('click', () => applyTextStyle('fontStyle', activeTextElement.style.fontStyle === 'italic' ? 'normal' : 'italic'));

    // --- INITIALIZATION ---
    updateStepUI();
    applyTheme(appState.theme);
});
</script>
</body>
</html>

